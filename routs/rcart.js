const user = require("../models/user");
const Cart=require("../models/cart");
const product = require("../models/product");


const router =require("express").Router();

router.get("/addcart/:val/:prod",async(req,res)=>{
    const dbcart = await Cart.find({"userID":req.params.val})

    if(dbcart!=""){
         
         
        
        try{
            const usercart=await Cart.findOneAndUpdate({"userID":req.params.val},{
                $push:{
                    products:req.params.prod
                }
            })
            
            
              
              
            
            
            const userval= await user.findById(req.params.val)
            const products= await product.findById(req.params.prod)
            res.render("productdetails.ejs",(val=userval,prod=products))
          
        
        
             
        }
    
    catch{
            res.status(401)
        }
        

    



    }else{
    const cart = await new Cart({
        userID:req.params.val,
        products:[req.params.prod ]

    })
    await cart.save().then(()=>{
        console.log("CArt ADDED");
    }).catch(err=>{
        console.log(err)

    })
    const userval= await user.findById(req.params.val)
    const products= await product.findById(req.params.prod)
    res.render("productdetails.ejs",(val=userval,prod=products))
    
}

})


router.get("/cart/:val",async(req,res)=>{

   
   
    const userval = await user.findById(req.params.val)
    if(await Cart.findOne({"userID":req.params.val})){
        const cart = await Cart.findOne({"userID":req.params.val})
        const cid = await cart.products
    
        const produ=[]

        for (let i = 0; i < cid.length; i++) {
             produ [i] = await product.findById(cid[i])
            
            
        }
        
       
        
        res.render("cart.ejs",(val=userval,prod=[produ]))
        console.log(produ);

         
    }else{
        res.render("cart.ejs",(val=userval,prod=""))
        

    }
    

  
   

   
})
router.get("/remove/:val/:prod",async(req,res)=>{
    try{
        const usercart=await Cart.findOneAndUpdate({"userID":req.params.val},{
            $pull:{
                products:req.params.prod
            }
        })
         
    const userval = await user.findById(req.params.val)
    if(await Cart.findOne({"userID":req.params.val})){
        const cart = await Cart.findOne({"userID":req.params.val})
        const cid = await cart.products
    
        const produ=[]

        for (let i = 0; i < cid.length; i++) {
             produ [i] = await product.findById(cid[i])
            
            
        }
        
       
        console.log(produ);
        res.render("cart.ejs",(val=userval,prod=produ))

         
    }else{
        res.render("cart.ejs",(val=userval,prod=""))
        

    }
    

  
   
 
    }

catch{
        res.status(401)
    }
    

    

})

router.get("/addcart//:prod",async(req,res)=>{
    res.redirect("/lr")




})















































































































































































































































































































































































































































































































































































































































































































module.exports=router;